{% extends "base.html" %}

{% block title %}
    NewGen Water and Wastewater Rate Database
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 0;" >
    <h1>Water and Wastewater Rates</h1>

    <!-- Add Utility Button -->
    <div class="mb-3">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#utilityModal">Add Utility</button>
    </div>

    <!-- DataTables Table -->
    <div class="table-responsive">
        <table id="utilityTable" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Actions</th>
                    <th>City</th>
                    <th>State</th>
                    <th>Client</th>
                    <th>Population</th>
                    <th>Winter Avg.</th>
                    <th>Meter Size</th>
                    <th>Effective Date</th>
                    <th>Water Min Bill</th>
                    {% for i in range(1, 11) %}
                    <th>Water Block {{ i }} Gallons</th>
                    {% endfor %}
                    {% for i in range(1, 11) %}
                    <th>Water Block {{ i }} Rate</th>
                    {% endfor %}
                    {% for i in range(1, 11) %}
                    <th>Wastewater Block {{ i }} Gallons</th>
                    {% endfor %}
                    {% for i in range(1, 11) %}
                    <th>Wastewater Block {{ i }} Rate</th>
                    {% endfor %}
                    <th>Source</th>
                </tr>
            </thead>
            <tbody>
                {% for utility in utilities %}
                <tr>
                    <td>
                        <div class="btn-group">
                            <button type="button" class="btn btn-primary edit-btn"
                                    data-id="{{ utility.id }}"
                                    data-city="{{ utility.city }}"
                                    data-state="{{ utility.state }}"
                                    data-client="{{ utility.client }}"
                                    data-population="{{ utility.population }}"
                                    data-winter_avg="{{ utility.winter_avg }}"
                                    data-meter_size="{{ utility.meter_size }}"
                                    data-effective_date="{{ utility.effective_date }}"
                                    data-source="{{ utility.source }}"
                                    data-w_min_bill="{{ utility.w_min_bill }}"
                                    data-ww_min_bill="{{ utility.ww_min_bill }}"
                                    {% for i in range(1, 11) %}
                                    data-water_gallons_{{ i }}="{{ utility.water_blocks[i-1].gallons if i <= utility.water_blocks|length else '' }}"
                                    data-water_rate_{{ i }}="{{ utility.water_blocks[i-1].rate if i <= utility.water_blocks|length else '' }}"
                                    data-wastewater_gallons_{{ i }}="{{ utility.wastewater_blocks[i-1].gallons if i <= utility.wastewater_blocks|length else '' }}"
                                    data-wastewater_rate_{{ i }}="{{ utility.wastewater_blocks[i-1].rate if i <= utility.wastewater_blocks|length else '' }}"
                                    {% endfor %}
                                    data-bs-toggle="modal"
                                    data-bs-target="#utilityModal">
                                Edit
                            </button>
                            <form action="{{ url_for('main.delete_utility', id=utility.id) }}" method="POST" style="display:inline;">
                                <button type="submit" class="btn btn-primary btn-danger" onclick="return confirm('Are you sure you want to delete this utility?');">
                                    Delete
                                </button>
                            </form>
                        </div>
                    </td>
                    <td>{{ utility.city }}</td>
                    <td>{{ utility.state }}</td>
                    <td>{{ utility.client }}</td>
                    <td data-field="population">{{ utility.population or '' }}</td>
                    <td>{{ utility.winter_avg or '' }}</td>
                    <td>{{ utility.meter_size or '' }}</td>
                    <td>{{ utility.effective_date.strftime('%Y-%m-%d') if utility.effective_date else '' }}</td>
                    <td>{{ utility.w_min_bill or '' }}</td>

                    {% for i in range(1, 11) %}
                    <td data-field="gallons_{{ i }}">{{ utility.water_blocks[i-1].gallons if i <= utility.water_blocks|length else '' }}</td>
                    {% endfor %}
                    {% for i in range(1, 11) %}
                    <td data-field="rate_{{ i }}">{{ utility.water_blocks[i-1].rate if i <= utility.water_blocks|length else '' }}</td>
                    {% endfor %}

                    {% for i in range(1, 11) %}
                    <td data-field="gallons_{{ i }}">{{ utility.wastewater_blocks[i-1].gallons if i <= utility.wastewater_blocks|length else '' }}</td>
                    {% endfor %}
                    {% for i in range(1, 11) %}
                    <td data-field="rate_{{ i }}">{{ utility.wastewater_blocks[i-1].rate if i <= utility.wastewater_blocks|length else '' }}</td>
                    {% endfor %}

                    <td>
                        {% if utility.source %}
                        <a href="{{ utility.source }}" target="_blank">{{ utility.source }}</a>
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<!-- Modal Form for Adding/Editing Utility -->
<div class="modal fade" id="utilityModal" tabindex="-1" aria-labelledby="utilityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="utilityForm" method="POST" action="{{ url_for('main.add_utility') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="utilityModalLabel">Add/Edit Utility</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Utility fields -->
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" class="form-control" id="city" name="city" required>
                    </div>
                    <div class="form-group">
                        <label for="state">State</label>
                        <input type="text" class="form-control" id="state" name="state" required>
                    </div>
                    <div class="form-group">
                        <label for="client">Client</label>
                        <select class="form-control" id="client" name="client">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="population">Population</label>
                        <input type="number" class="form-control" id="population" name="population">
                    </div>
                    <div class="form-group">
                        <label for="winter_avg">Winter Avg</label>
                        <select class="form-control" id="winter_avg" name="winter_avg">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="meter_size">Meter Size</label>
                        <input type="text" class="form-control" id="meter_size" name="meter_size">
                    </div>
                    <div class="form-group">
                        <label for="effective_date">Effective Date</label>
                        <input type="date" class="form-control" id="effective_date" name="effective_date">
                    </div>
                    <div class="form-group">
                        <label for="source">Source</label>
                        <input type="text" class="form-control" id="source" name="source">
                    </div>
                    <div class="form-group">
                        <label for="w_min_bill">Water Min Bill</label>
                        <input type="number" class="form-control" id="w_min_bill" name="w_min_bill" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="ww_min_bill">Wastewater Min Bill</label>
                        <input type="number" class="form-control" id="ww_min_bill" name="ww_min_bill" step="0.01">
                    </div>


                    <!-- Water Blocks -->
                    <h5>Water Blocks</h5>
                    <div class="row">
                        {% for i in range(1, 11) %}
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="water_gallons_{{ i }}">Block {{ i }} Gallons</label>
                                <input type="number" class="form-control" id="water_gallons_{{ i }}" name="water_gallons_{{ i }}" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="water_rate_{{ i }}">Block {{ i }} Rate</label>
                                <input type="number" class="form-control" id="water_rate_{{ i }}" name="water_rate_{{ i }}" step="0.01">
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Wastewater Blocks -->
                    <h5>Wastewater Blocks</h5>
                    <div class="row">
                        {% for i in range(1, 11) %}
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="wastewater_gallons_{{ i }}">Block {{ i }} Gallons</label>
                                <input type="number" class="form-control" id="wastewater_gallons_{{ i }}" name="wastewater_gallons_{{ i }}" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="wastewater_rate_{{ i }}">Block {{ i }} Rate</label>
                                <input type="number" class="form-control" id="wastewater_rate_{{ i }}" name="wastewater_rate_{{ i }}" step="0.01">
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
    {% endblock %}

    {% block scripts %}
<script>
    $(document).ready(function () {
        ensureNonEmptyCells();
        $('#utilityTable').DataTable({
            dom: 'Bfrtip',
            buttons: [
                'copy', 'csv', 'excel', 'pdf', 'print'
            ]
        });

        formatPopulationAndGallons();
        formatRates();
    });

    function ensureNonEmptyCells() {
        $('td').each(function () {
            if ($(this).html().trim() === '') {
                $(this).html('');
            }
        });
    }

    function formatNumber(number) {
        return new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(number);
    }

    function formatCurrency(number) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2
        }).format(number);
    }

    function formatPopulationAndGallons() {
        // Format Population field
        document.querySelectorAll('td[data-field="population"]').forEach(function (element) {
            let number = element.textContent.trim();
            if (number && !isNaN(number)) {
                element.textContent = formatNumber(parseInt(number));
            } else {
                element.textContent = ''; // Set to blank if empty or not a number
            }
        });

        // Format all Gallons fields
        document.querySelectorAll('td[data-field^="gallons"]').forEach(function (element) {
            let number = element.textContent.trim();
            if (number && !isNaN(number)) {
                element.textContent = formatNumber(parseInt(number));
            } else {
                element.textContent = ''; // Set to blank if empty or not a number
            }
        });
    }

    function formatRates() {
        // Format all Rate fields
        document.querySelectorAll('td[data-field^="rate"]').forEach(function (element) {
            let number = element.textContent.trim();
            if (number && !isNaN(number)) {
                element.textContent = formatCurrency(parseFloat(number));
            } else {
                element.textContent = ''; // Set to blank if empty or not a number
            }
        });
    }

    // Populate the modal with data when editing a utility
    $(document).ready(function () {
        $('#utilityModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget); // Button that triggered the modal
            var modal = $(this);

            // Determine if it's an edit or add operation
            var id = button.data('id') || '';  // If there's no ID, it's an add operation

            // Update the modal's title and form action
            modal.find('.modal-title').text(id ? 'Edit Utility' : 'Add Utility');

            // Populate fields if editing, otherwise clear fields
            modal.find('#city').val(button.data('city') || '');
            modal.find('#state').val(button.data('state') || '');
            modal.find('#client').val(button.data('client') || '');
            modal.find('#population').val(button.data('population') || '');
            modal.find('#winter_avg').val(button.data('winter_avg') || '');
            modal.find('#meter_size').val(button.data('meter_size') || '');
            modal.find('#effective_date').val(button.data('effective_date') || '');
            modal.find('#source').val(button.data('source') || '');
            modal.find('#w_min_bill').val(button.data('w_min_bill') || '');
            modal.find('#ww_min_bill').val(button.data('ww_min_bill') || '');

            // Populate blocks (clear if adding new)
            for (var i = 1; i <= 10; i++) {
                modal.find('#water_gallons_' + i).val(button.data('water_gallons_' + i) || '');
                modal.find('#water_rate_' + i).val(button.data('water_rate_' + i) || '');
                modal.find('#wastewater_gallons_' + i).val(button.data('wastewater_gallons_' + i) || '');
                modal.find('#wastewater_rate_' + i).val(button.data('wastewater_rate_' + i) || '');
            }

            // Set the correct form action URL based on whether we are adding or editing
            if (id) {
                $('#utilityForm').attr('action', '/update_utility/' + id);
            } else {
                $('#utilityForm').attr('action', '/add_utility');
            }
        });
    });


</script>
    {% endblock %}
